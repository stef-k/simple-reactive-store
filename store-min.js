export const createStore=(t={})=>{const e="string"==typeof t?{name:t}:t,{name:n,initialState:o={},enableDevPanel:s=!1,syncStorage:a=!1,storageDriver:r=localStorage,storageEncrypt:d=JSON.stringify,storageDecrypt:c=JSON.parse}=e,i=!0===a?Object.keys(o):Array.isArray(a)?a:[],l=structuredClone(o),u=(t,e)=>e.split(".").reduce(((t,e)=>(t||{})[e]),t),p=(t,e,n)=>{const o=e.split("."),s=o.pop();o.reduce(((t,e)=>t[e]??={}),t)[s]=n};for(const t of i){const e=r.getItem(t);if(null!==e)try{p(l,t,c(e))}catch{p(l,t,e)}}const f=new Set,y=new Map,g=new Map,m=new Set,h=(t,e)=>{const n=structuredClone(l);f.forEach((n=>n({type:t,payload:e}))),m.forEach((t=>t(l,n))),"function"==typeof window.__storeDebugUpdate&&window.__storeDebugUpdate()},b={__syncKeys:i,getState:()=>structuredClone(l),dispatch:(t,e)=>{if("string"==typeof t){const[n,o]=t.split("-");if("set"===n&&o&&o.length){l[o]=e,S(o);for(const t of b.__syncKeys){if(o===t.split(".")[0]||o===t)try{const e=u(l,t);r.setItem(t,d(e))}catch{}}}}h(t,e)},subscribe:t=>(f.add(t),()=>f.delete(t)),watch:(t,e)=>{let n=structuredClone(l[t]);return b.subscribe((()=>{const o=l[t];("object"==typeof o&&null!==o?JSON.stringify(o)!==JSON.stringify(n):o!==n)&&(n=structuredClone(o),e(o))}))},watchAll:t=>(m.add(t),()=>m.delete(t)),when:(t,e)=>b.subscribe((({type:n,payload:o})=>{n===t&&e(o)})),once:(t,e)=>{const n=b.when(t,(t=>{e(t),n()}))},emit:(t,e)=>b.dispatch(t,e),computed:(t,e)=>{y.set(t,e)},get:t=>y.has(t)?y.get(t)(l):l[t],bind:(t,e)=>{g.has(t)||g.set(t,new Set),document.querySelectorAll(e).forEach((e=>{g.get(t).add(e),w(e,t)}))},autoBind:()=>{const t=new Set;document.querySelectorAll("[data-model]").forEach((e=>{const n=e.dataset.model;if(!n)return;if(b.bind(n,`[data-model="${n}"]`),t.add(n),e.dataset.modelBound)return;e.dataset.modelBound="true";const o="SELECT"===e.tagName||"INPUT"===e.tagName?"input":"change";if(e.addEventListener(o,(()=>{const t=e.value;u(l,n)!==t&&(p(l,n,t),b.dispatch(`set-${n}`,t,{skipHistory:!0}),"localStorage"===e.dataset.sync&&r.setItem(n,t))})),"localStorage"===e.dataset.sync){const t=r.getItem(n);null!==t&&(b.dispatch(`set-${n}`,t),e.value=t),b.watchPath(n,(t=>r.setItem(n,t)))}})),document.querySelectorAll("[data-bind]").forEach((e=>{const n=e.dataset.bind;n&&!t.has(n)&&b.bind(n,`[data-bind="${n}"]`)}))},link:(t,e,n)=>{t.watch(e,(t=>{const o="function"==typeof n?n(t):t;b.dispatch(`set-${e}`,o)}))},linkTwoWay:(t,e,n,o)=>{let s=!1;t.watch(e,(t=>{if(s)return;s=!0;const o="function"==typeof n?n(t):t;b.dispatch(`set-${e}`,o),s=!1})),b.watch(e,(n=>{if(s)return;s=!0;const a="function"==typeof o?o(n):n;t.dispatch(`set-${e}`,a),s=!1}))},bindAll:t=>{const e=e=>t.querySelectorAll(e),n=new Set;e("[data-model]").forEach((t=>{const e=t.dataset.model;if(!e)return;if(b.bind(e,`[data-model="${e}"]`),n.add(e),t.dataset.modelBound)return;t.dataset.modelBound="true";const o="SELECT"===t.tagName||"INPUT"===t.tagName?"input":"change";if(t.addEventListener(o,(()=>{const n=t.value;u(l,e)!==n&&(p(l,e,n),b.dispatch(`set-${e}`,n),"localStorage"===t.dataset.sync&&r.setItem(e,n))})),"localStorage"===t.dataset.sync){const n=r.getItem(e);null!==n&&(b.dispatch(`set-${e}`,n),t.value=n),b.watchPath(e,(t=>r.setItem(e,t)))}})),e("[data-bind]").forEach((t=>{const e=t.dataset.bind;e&&!n.has(e)&&b.bind(e,`[data-bind="${e}"]`)}))},linkPath:(t,e,n,o)=>{t.watchAll((t=>{const s=u(t,e);if(void 0!==s){const t=o?o(s):s;b.dispatch(`set-${n}`,t)}}))},watchPath:(t,e)=>{let n=structuredClone(u(l,t));return b.subscribe((()=>{const o=u(l,t);("object"==typeof o&&null!==o?JSON.stringify(o)!==JSON.stringify(n):o!==n)&&(n=structuredClone(o),e(o))}))}},w=(t,e)=>{let n=l[e]??"";"uppercase"===t.dataset.format?n=String(n).toUpperCase():"lowercase"===t.dataset.format?n=String(n).toLowerCase():"currency"===t.dataset.format?n=`$${parseFloat(n).toFixed(2)}`:"percent"===t.dataset.format?n=100*parseFloat(n)+"%":"iso-date"===t.dataset.format&&(n=new Date(n).toISOString());const o=t.dataset.prefix||"",s=t.dataset.suffix||"";t.textContent=`${o}${n}${s}`},S=t=>{const e=g.get(t);e&&e.forEach((e=>w(e,t)))};n&&(window[`${n}Store`]=b,window[`${n}State`]=()=>{});const x=[structuredClone(l)];let C=0;const E=()=>{const t=structuredClone(l);x.splice(C+1),x.push(t),C++},v=t=>{t<0||t>=x.length||(Object.keys(l).forEach((t=>delete l[t])),Object.assign(l,structuredClone(x[t])),f.forEach((t=>t({type:"history-jump",payload:l}))),m.forEach((t=>t(l,l))),"function"==typeof window.__storeDebugUpdate&&window.__storeDebugUpdate())};b.undo=()=>!(C<=0)&&(C--,v(C),!0),b.redo=()=>!(C>=x.length-1)&&(C++,v(C),!0),b.__getHistory=()=>structuredClone(x),b.jumpTo=t=>{"number"==typeof t&&t>=0&&t<x.length&&(v(t),C=t)},E();const I=b.dispatch.bind(b);let $;if(b.dispatch=(t,e,n={})=>{const o=structuredClone(l);I(t,e);JSON.stringify(o)!==JSON.stringify(l)&&!n.skipHistory&&(E(),"function"==typeof $&&$())},s&&"undefined"!=typeof window){const t=document.createElement("div");t.style="\n      position:fixed;bottom:14px;right:0;z-index:9999;\n      font:12px monospace;max-width:600px;\n      background:#fff;border:1px solid #ccc;box-shadow:0 0 4px rgba(0,0,0,.25);\n      height:20px;\n    ",t.innerHTML='\n    <div style="display:flex;justify-content:space-between;padding:4px 6px;background:#f5f5f5">\n      <strong style="margin-right: 15px;margin-top: 6.5px;">Store </strong>\n      <select class="form-select form-select-sm ms-auto" id="wfHistoryJump" style="width: auto;">\n        <option value="0">State #0</option>\n      </select>\n      <div class="d-flex gap-2 align-items-center">\n        <button class="btn btn-sm btn-outline-secondary" id="wfUndo">◀</button>\n        <button class="btn btn-sm btn-outline-secondary" id="wfRedo">▶</button>\n        <button class="btn btn-sm btn-outline-secondary" id="wfToggleStore">Show</button>\n      </div>\n    </div>\n    <div id="wfStoreControls" style="padding:4px 6px;display:flex;gap:4px">\n      <button class="btn btn-sm btn-outline-primary" id="wfStoreRefresh">Refresh</button>\n      <button class="btn btn-sm btn-outline-danger"  id="wfStoreClear">Clear</button>\n    </div>\n    <pre id="wfStoreDump" style="margin:0;padding:6px 6px 8px;height:140px;overflow:auto;display:none;"></pre>',document.body.appendChild(t);const e=document.getElementById("wfStoreDump"),n=document.getElementById("wfToggleStore"),s=document.getElementById("wfStoreRefresh"),a=document.getElementById("wfStoreClear"),d=document.getElementById("wfHistoryJump");$=()=>{d.innerHTML="",b.__getHistory().forEach(((t,e)=>{const n=document.createElement("option");n.value=e,n.textContent=`State #${e}`,e===C&&(n.selected=!0),d.appendChild(n)}))},d.onchange=()=>{const t=parseInt(d.value);b.jumpTo(t),$()};let c=!1;const i=()=>{e.textContent=JSON.stringify(b.getState(),null,2)};window.__storeDebugUpdate=i,s.onclick=i,a.onclick=()=>{for(const t of b.__syncKeys)try{r.removeItem(t)}catch{}Object.keys(l).forEach((t=>delete l[t])),Object.assign(l,structuredClone(o)),x.length=0,x.push(structuredClone(l)),C=0;for(const t of Object.keys(l))S(t);h("devpanel-clear",structuredClone(l)),i(),$?.()},n.onclick=()=>{c=!c,t.style.height=c?"auto":"20px",e.style.display=c?"block":"none",n.textContent=c?"Hide":"Show"};const u=document.getElementById("wfUndo"),p=document.getElementById("wfRedo");u&&(u.onclick=()=>b.undo()),p&&(p.onclick=()=>b.redo()),window.addEventListener("keydown",(t=>{(navigator.platform.toLowerCase().includes("mac")?t.metaKey:t.ctrlKey)&&"z"===t.key.toLowerCase()&&(t.shiftKey?b.redo():b.undo(),t.preventDefault())})),i()}return b};